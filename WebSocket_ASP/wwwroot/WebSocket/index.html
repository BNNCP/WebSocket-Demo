<!DocType html>
<html lang="zh-cn">

<head>
    <title>RealTime Demo</title>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" type="text/css">
    <link rel="stylesheet" href="./dialogue.css" type="text/css">
</head>

<body>

    <div class="game-container">
    </div>
    <div class="player-info">
        <div>
            <label for="player-name">Your Name</label>
            <input id="player-name" maxlength="10" type="text" />
        </div>
        <div>
            <button id="player-color">Change Color</button>
        </div>
        <span>Msg</span><input type="text" id="txtMsg" /> <br />
        <button id="btnSend">send</button> <br />
        <label id="lbMsg"></label>
    </div>


    <div id="dialog-box">
        <div class="dialog-header">
            <span class="dialog-title">對話視窗</span>
            <span class="dialog-close-btn">x</span>
        </div>
        <div class="dialog">
            <div id="dialog" class="dialog-body"></div>
            <div id="dialog-time" class="dialog-time"></div>
        </div>
        <div class="dialog-footer">
            <input type="text" id="dialog-input" placeholder="請輸入訊息">
            <button id="dialog-send-btn">發送</button>
        </div>
    </div>

    <br />




    <script>
        var server = 'wss://localhost:7184'; //如果开启了https则这里是wss
        var vWebSocket = null;
        window.onload = function () {
            //建立一個web socket 連線
            vWebSocket = new WebSocket(server + '/ws');
            document.getElementById("dialog-send-btn").addEventListener("click", sendMsg);
            //如果連線成功
            vWebSocket.onopen = function (e) {
                console.log('connection start ...');
                console.log(e);
                console.log(vWebSocket);
                var content = document.getElementById("lbMsg");
                content.innerText = content.innerText + '\r\n' + "conection.....";
            }
            //接收到訊息時
            vWebSocket.onmessage = function (e) {
                console.log('Recevied Message:' + e.data);
                let result = JSON.parse(e.data);
                if (e.data) {
                    switch (result.type) {
                        case "Chat":
                            const content = document.getElementById("dialog");
                            const timecontent = document.getElementById("dialog-time");
                            var today = new Date();
                            var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
                            var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                            var dateTime = date + ' ' + time;
                            let message = `${result.client.Uid}: ${result.content}`;
                            timecontent.innerText = timecontent.innerText + '\r\n' + dateTime;
                            content.innerText = content.innerText + '\r\n' + message;
                            break;
                        case "Connect":
                            console.log(result.Uid + result.name + " has logged in")
                            break;
                        case "Movement":
                            break
                    }

                }
            }
            //關閉連線時
            vWebSocket.onclose = function (e) {
                console.log("connection closed");
            }
        };

        function sendMsg() {
            var txtMsg = document.getElementById("dialog-input").value;
            if (txtMsg) {
                var data = {
                    "type": "Chat",
                    "data": txtMsg
                };
                vWebSocket.send(JSON.stringify(data));
            }
        }

    </script>
    <script src="./KeyPressListener.js"></script>
    <script src="./dialogue.js"></script>
</body>

</html>